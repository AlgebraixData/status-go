language: go

go:
  - 1.8

sudo: required

services:
  - docker

dist: trusty

notifications:
  slack:
    rooms:
      - secure: LppI+UB3X1MTd383mc4vRcXPgUKQDiGQb261ODBpEphHF5odH+oL8Eq4cEzuGGoRlDgcXlfzrBl3QdyEU3UOh83DMWV07NUyZErNHMiiiYTyP4mF8YG9pD/rHYAVBoL1GYoV+R85ABuuNaEvehb1eczNvETT01Y++SbL6lc4HOCRLDj+KW/Cq0M/O4D9xrm71teQIuRWMxIuphY+Y7M2SOq+QoFle7LF5Q4Bo1K8KzjeZtTiONdK1I6RV54DNZDgK37rvrnWJD24pp+6XJBp2GwRqpam85219UUzw34y1EBSiBWUolegYjM8rcoLJhu34/MI1cTnygRZ1aYhhFTjAHYn0Ncw80wCpG8kyvlEQkVappIIXK7n3Yfy4SXmNsLAXMfDVUjdzb4ms/7gBUda2ymnDsmb7pMrU+r2LBoIc0qMQoxhwo4zz4A1WXYezG445vpRqVj69R9GT/q8NuAB/jvFlgfwyq8jtBrxXmXswXjeIZPLeVJ+ktqzhJilFpucYepjVStHVVUq16mnEZwmwVRAe5J6AWDZviajYXeqLhDZDvu2+clie2/s+oH0kw8X58oSvNtRrpDjsrhk4Q27SJ7+df35KyNBwNcxi3XPSsHOmCskE/EfJjKqSboPQzICg/j93YP13IepjI39VlFr/1renxpENFo9G+2tLJxsqao=
    on_pull_requests: true
    on_success: change
    on_failure: always

# The remainder of this file are the steps of the hardcoded Travis sequence in the order they are executed.

before_install:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') before_install"

install:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') install"
  - go get golang.org/x/tools/cmd/cover

before_script:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') before_script"

script:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') script"
  - make ci
# TODO Temporarily moved to before_deploy to make CI turnaround faster.
#  - make statusgo-android
#  - make statusgo-ios-simulator && mv build/bin/statusgo-ios-9.3-framework build/bin/statusgo-ios-9.3-framework-simulator
#  - make statusgo-ios

before_cache:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') before_cache"

cache:
  directories:
  - .ethereumtest

after_success:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') after_success"

after_failure:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') after_failure"

before_deploy:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') before_deploy"
  # TODO These are temporarily moved to here from script ...
  - make statusgo-android
  - make statusgo-ios-simulator && mv build/bin/statusgo-ios-9.3-framework build/bin/statusgo-ios-9.3-framework-simulator
  - make statusgo-ios
  # TODO ... normal before_deploy.
  - cp build/index.html build/bin/index.html
  - pushd build/bin/statusgo-ios-9.3-framework && zip -ry ../Statusgo-framework.zip Statusgo.framework && popd
  - rm -rf build/bin/statusgo-ios-9.3-framework
  - unzip -l build/bin/Statusgo-framework.zip
  - pushd build/bin/statusgo-ios-9.3-framework-simulator && zip -ry ../Statusgo-framework-simulator.zip Statusgo.framework && popd
  - rm -rf build/bin/statusgo-ios-9.3-framework-simulator \
  - zipinfo build/bin/Statusgo-framework-simulator.zip
  - rm -f build/bin/xgo

deploy:
  provider: pages
  skip_cleanup: true
  github_token: $GITHUB_TOKEN
  on:
    branch:
      - master
      - develop
  local_dir: build/bin
  target_branch: gh-pages

after_deploy:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') after_deploy"

after_script:
  - echo "*** $(date '+%Y-%m-%d %H:%M:%S') after_script"
